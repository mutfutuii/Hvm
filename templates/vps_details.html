{% extends 'base.html' %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<style>
    /* Custom styles for better UI/UX */
    .card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .status-badge {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
    }
    
    .btn-group {
        gap: 0.5rem;
    }
    
    .btn {
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    
    .info-item {
        background: #22221d;
        border-radius: 8px;
        padding: 1rem;
        border-left: 4px solid #0d6efd;
    }
    
    .info-item dt {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .info-item dd {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 0;
        word-break: break-all;
    }
    
    .copy-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .utility-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .utility-buttons {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
    }
    
    /* Toast notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1055;
    }
    
    .toast {
        background: #28a745;
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Chart improvements */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    /* Loading states */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
</style>
{% endblock %}

{% block title %}VPS Details - {{ vps.vps_id }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Toast Notification -->
    <div class="toast-container">
        <div id="copyToast" class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i> Password copied to clipboard!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- VPS Info -->
    <div class="card shadow-lg mb-4">
        <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white py-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-hdd-network me-3 fs-3"></i>
                <div>
                    <h4 class="mb-0">VPS {{ vps.vps_id }}</h4>
                    <small class="opacity-75">Created: {{ vps.created_at }}</small>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <span class="status-badge bg-{{ 'success' if container_status == 'running' else 'danger' if container_status == 'stopped' else 'warning' }} me-3">
                    <i class="bi bi-{{ 'play-circle' if container_status == 'running' else 'stop-circle' if container_status == 'stopped' else 'exclamation-circle' }} me-1"></i>
                    {{ container_status | capitalize }}
                </span>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="vpsActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-4">
            <div class="info-grid">
                <div class="info-item">
                    <dt>Server IP</dt>
                    <dd><code>{{ server_ip }}</code></dd>
                </div>
                
                <div class="info-item">
                    <dt>SSH Port</dt>
                    <dd><code>{{ vps.port }}</code></dd>
                </div>
                
                <div class="info-item">
                    <dt>Username</dt>
                    <dd><span class="badge bg-dark">root</span></dd>
                </div>
                
                <div class="info-item">
                    <dt>Password</dt>
                    <dd>
                        <div class="d-flex align-items-center">
                            <code id="rootPassword" class="me-2">{{ vps.root_password }}</code>
                            <button class="btn btn-sm btn-outline-primary copy-btn" onclick="copyPassword()" title="Copy password">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </dd>
                </div>
                
                <div class="info-item">
                    <dt>Memory</dt>
                    <dd>{{ vps.memory }} GB</dd>
                </div>
                
                <div class="info-item">
                    <dt>CPU</dt>
                    <dd>{{ vps.cpu }} cores</dd>
                </div>
                
                <div class="info-item">
                    <dt>Disk</dt>
                    <dd>{{ vps.disk }} GB</dd>
                </div>
                
                <div class="info-item">
                    <dt>OS Image</dt>
                    <dd>{{ vps.os_image }}</dd>
                </div>
                
                <div class="info-item">
                    <dt>Expires At</dt>
                    <dd>
                        {% if vps.expires_at %}
                            {% if vps.is_expired %}
                                <span class="badge bg-danger ms-1">Expired</span>
                            {% else %}
                                <span class="badge bg-warning ms-1">Active</span>
                            {% endif %}
                        {% else %}
                            Never
                        {% endif %}
                    </dd>
                </div>
                
                <div class="info-item">
                    <dt>Tmate Session</dt>
                    <dd>
                        {% if vps.tmate_session %}
                            <code>{{ vps.tmate_session }}</code>
                            <button class="btn btn-sm btn-outline-primary copy-btn ms-1" onclick="copyToClipboard('{{ vps.tmate_session }}')" title="Copy tmate session">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        {% else %}
                            <span class="text-muted">Not available</span>
                        {% endif %}
                    </dd>
                </div>
                
                <div class="info-item">
                    <dt>Additional Ports</dt>
                    <dd>
                        {% if vps.additional_ports %}
                            {% for port in vps.additional_ports.split(',') %}
                                <span class="badge bg-info me-1">{{ port.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </dd>
                </div>
                
                <div class="info-item">
                    <dt>Bandwidth Limit</dt>
                    <dd>{{ vps.bandwidth_limit }} MB</dd>
                </div>
                
                <div class="info-item">
                    <dt>Tags</dt>
                    <dd>
                        {% if vps.tags %}
                            {% for tag in vps.tags.split(',') %}
                                <span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </dd>
                </div>
                
                <div class="info-item">
                    <dt>Groups</dt>
                    <dd>
                        {% if groups %}
                            {% for group in groups %}
                                <span class="badge bg-secondary me-1">{{ group.name }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </dd>
                </div>
            </div>
        </div>
        
<div class="card-footer p-3">
    <div class="action-buttons mb-3">
        <a href="/vps/{{ vps.vps_id }}/start" class="btn btn-success" id="startBtn">
            <i class="bi bi-play-circle"></i> Start
        </a>
        <a href="/vps/{{ vps.vps_id }}/stop" class="btn btn-warning" id="stopBtn">
            <i class="bi bi-stop-circle"></i> Stop
        </a>
        <a href="/vps/{{ vps.vps_id }}/restart" class="btn btn-info text-white" id="restartBtn">
            <i class="bi bi-arrow-repeat"></i> Restart
        </a>
        <a href="/vps/{{ vps.vps_id }}/console" class="btn btn-dark">
            <i class="bi bi-terminal"></i> Console
        </a>
        <form action="/vps/{{ vps.vps_id }}/change_password" method="POST" style="display: inline;">
            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                <i class="bi bi-key"></i> Change Password
            </button>
        </form>
    </div>
</div>
            
            <div class="utility-buttons">
                <a href="/vps/{{ vps.vps_id }}/firewall" class="btn btn-outline-primary">
                    <i class="bi bi-shield-check"></i> Firewall
                </a>
                <a href="/vps/{{ vps.vps_id }}/snapshots" class="btn btn-outline-primary">
                    <i class="bi bi-camera"></i> Snapshots
                </a>
                <a href="/vps/{{ vps.vps_id }}/file_manager" class="btn btn-outline-primary">
                    <i class="bi bi-folder"></i> File Manager
                </a>
                <a href="/vps/{{ vps.vps_id }}/processes" class="btn btn-outline-primary">
                    <i class="bi bi-diagram-3"></i> Processes
                </a>
                <a href="/vps/{{ vps.vps_id }}/services" class="btn btn-outline-primary">
                    <i class="bi bi-gear"></i> Services
                </a>
                <a href="/vps/{{ vps.vps_id }}/packages" class="btn btn-outline-primary">
                    <i class="bi bi-box"></i> Packages
                </a>
                <a href="/vps/{{ vps.vps_id }}/vps_users" class="btn btn-outline-primary">
                    <i class="bi bi-people"></i> Users
                </a>
                <a href="/vps/{{ vps.vps_id }}/cron" class="btn btn-outline-primary">
                    <i class="bi bi-clock"></i> Cron Jobs
                </a>
                <a href="/vps/{{ vps.vps_id }}/view_logs" class="btn btn-outline-primary">
                    <i class="bi bi-journal-text"></i> View Logs
                </a>
            </div>
        </div>
    </div>

    <!-- Resource History -->
    <div class="card shadow-lg mb-4">
        <div class="card-header bg-gradient-secondary text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-activity me-2"></i> Resource Usage History</h5>
                <div>
                    <select id="timeRange" class="form-select form-select-sm" onchange="updateChart()">
                        <option value="1h">Last 1 hour</option>
                        <option value="6h">Last 6 hours</option>
                        <option value="12h">Last 12 hours</option>
                        <option value="24h" selected>Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body p-4">
            <div class="chart-container">
                <canvas id="resourceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Copy password function
    function copyPassword() {
        const pwd = document.getElementById("rootPassword").textContent;
        copyToClipboard(pwd);
    }
    
    // Generic copy to clipboard function
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Copied to clipboard!');
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Failed to copy to clipboard. Please copy manually.');
            }
            document.body.removeChild(textArea);
        });
    }
    
    // Show toast notification
    function showToast(message) {
        const toastEl = document.getElementById('copyToast');
        const toastBody = toastEl.querySelector('.toast-body');
        toastBody.innerHTML = `<i class="bi bi-check-circle-fill me-2"></i> ${message}`;
        
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
    
    // Confirm deletion
    function confirmDelete() {
        return confirm('Are you sure you want to delete this VPS? This action cannot be undone.');
    }
    
    // Resource Chart
    let resourceChart;
    const ctx = document.getElementById('resourceChart').getContext('2d');
    const history = {{ history | tojson | safe }};
    
    // Format timestamps for display
    function formatTimestamp(timestamp, range) {
        const date = new Date(timestamp);
        if (range === '1h' || range === '6h') {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else if (range === '12h' || range === '24h') {
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } else {
            return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
        }
    }
    
    // Filter data based on time range
    function filterDataByRange(data, range) {
        const now = new Date();
        let cutoffTime;
        
        switch(range) {
            case '1h': cutoffTime = new Date(now - 60*60*1000); break;
            case '6h': cutoffTime = new Date(now - 6*60*60*1000); break;
            case '12h': cutoffTime = new Date(now - 12*60*60*1000); break;
            case '24h': cutoffTime = new Date(now - 24*60*60*1000); break;
            case '7d': cutoffTime = new Date(now - 7*24*60*60*1000); break;
            default: cutoffTime = new Date(now - 24*60*60*1000);
        }
        
        return data.filter(item => new Date(item.timestamp) >= cutoffTime);
    }
    
    // Update chart based on selected time range
    function updateChart() {
        const range = document.getElementById('timeRange').value;
        const filteredHistory = filterDataByRange(history, range);
        const labels = filteredHistory.map(h => formatTimestamp(h.timestamp, range));
        
        resourceChart.data.labels = labels;
        resourceChart.data.datasets[0].data = filteredHistory.map(h => h.cpu_percent);
        resourceChart.data.datasets[1].data = filteredHistory.map(h => h.memory_percent);
        resourceChart.data.datasets[2].data = filteredHistory.map(h => h.disk_usage);
        
        resourceChart.update();
    }
    
    // Initialize chart
    function initChart() {
        const range = document.getElementById('timeRange').value;
        const filteredHistory = filterDataByRange(history, range);
        const labels = filteredHistory.map(h => formatTimestamp(h.timestamp, range));
        
        const data = {
            labels: labels,
            datasets: [
                {
                    label: 'CPU Usage (%)',
                    data: filteredHistory.map(h => h.cpu_percent),
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                },
                {
                    label: 'Memory Usage (%)',
                    data: filteredHistory.map(h => h.memory_percent),
                    borderColor: '#f44336',
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                },
                {
                    label: 'Disk Usage (%)',
                    data: filteredHistory.map(h => h.disk_usage),
                    borderColor: '#2196f3',
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }
            ]
        };
        
        resourceChart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        padding: 10,
                        cornerRadius: 4
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { 
                            callback: value => value + "%",
                            stepSize: 20
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Update quick stats
    function updateQuickStats() {
        // In a real application, you would fetch this data from the server
        // For now, we'll simulate with random data
        if (history && history.length > 0) {
            const latest = history[history.length - 1];
            
            // Simulate uptime (this would normally come from the server)
            const uptimeDays = Math.floor(Math.random() * 30);
            const uptimeHours = Math.floor(Math.random() * 24);
            document.getElementById('uptimeStat').textContent = `${uptimeDays}d ${uptimeHours}h`;
            
            // Simulate bandwidth usage
            const bandwidthUsed = Math.floor(Math.random() * {{ vps.bandwidth_limit }});
            document.getElementById('bandwidthStat').textContent = `${bandwidthUsed} MB / {{ vps.bandwidth_limit }} MB`;
            
            // Simulate active connections
            const connections = Math.floor(Math.random() * 50);
            document.getElementById('connectionsStat').textContent = connections;
        }
    }
    
    // Add loading states to action buttons
    document.addEventListener('DOMContentLoaded', function() {
        const actionButtons = document.querySelectorAll('#startBtn, #stopBtn, #restartBtn');
        
        actionButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // If the VPS is already in the requested state, prevent action
                const action = this.getAttribute('href').split('/').pop();
                const currentStatus = '{{ container_status }}';
                
                if ((action === 'start' && currentStatus === 'running') ||
                    (action === 'stop' && currentStatus === 'stopped') ||
                    (action === 'restart' && currentStatus === 'stopped')) {
                    e.preventDefault();
                    showToast(`VPS is already ${currentStatus}.`);
                    return;
                }
                
                // Show loading state
                this.classList.add('loading');
                const originalText = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Processing...';
                
                // Revert after 3 seconds if the page doesn't change
                setTimeout(() => {
                    this.classList.remove('loading');
                    this.innerHTML = originalText;
                }, 3000);
            });
        });
        
        // Initialize chart and stats
        initChart();
        updateQuickStats();
        
        // Auto-refresh stats every 30 seconds
        setInterval(updateQuickStats, 3000);
    });
</script>
{% endblock %}