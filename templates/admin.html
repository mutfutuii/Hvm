{% extends 'base.html' %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Admin Panel</h1>
    <div>
      <a href="/admin/metrics" class="btn btn-outline-secondary me-2" data-bs-toggle="tooltip" title="Open system metrics">Metrics</a>
      <a href="/admin/settings" class="btn btn-primary">Settings</a>
    </div>
  </div>

  {# Flash / alerts #}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div>
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  <!-- Summary cards -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Total VPS</small>
          <div class="d-flex align-items-end justify-content-between">
            <h4 class="mb-0">{{ total_vps | default(0) }}</h4>
            <a href="" class="small">View</a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Total Users</small>
          <div class="d-flex align-items-end justify-content-between">
            <h4 class="mb-0">{{ total_users | default(0) }}</h4>
            <a href="" class="small">View</a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Banned Users</small>
          <div class="d-flex align-items-end justify-content-between">
            <h4 class="mb-0 text-warning">{{ total_banned | default(0) }}</h4>
            <a href="" class="small">Manage</a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <small class="text-muted">Total Restarts</small>
          <div class="d-flex align-items-end justify-content-between">
            <h4 class="mb-0">{{ total_restarts | default(0) }}</h4>
            <a href="" class="small">Logs</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- System Settings (collapsible) -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">System Settings</h5>
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false" aria-controls="settingsCollapse">Edit</button>
    </div>
    <div class="collapse show" id="settingsCollapse">
      <div class="card-body">
        <form method="post" action="/admin/settings" class="row g-3">
          {{ csrf_token() if csrf_token is defined }}

          <div class="col-md-6">
            <label for="panel_name" class="form-label">Panel Name</label>
            <input type="text" class="form-control" id="panel_name" name="panel_name" value="{{ panel_name|default('') }}" aria-describedby="panelNameHelp">
            <div id="panelNameHelp" class="form-text">Shown in navbar and email templates.</div>
          </div>

          <div class="col-md-6">
            <label for="watermark" class="form-label">Watermark</label>
            <input type="text" class="form-control" id="watermark" name="watermark" value="{{ watermark|default('') }}">
          </div>

          <div class="col-md-6">
            <label for="welcome_message" class="form-label">Welcome Message</label>
            <input type="text" class="form-control" id="welcome_message" name="welcome_message" value="{{ welcome_message|default('') }}">
          </div>

          <div class="col-md-6">
            <label for="server_ip" class="form-label">Server IP</label>
            <input type="text" class="form-control" id="server_ip" name="server_ip" value="{{ server_ip|default('') }}">
          </div>

          <div class="col-md-6">
            <label for="max_containers" class="form-label">Max Containers</label>
            <input type="number" min="0" class="form-control" id="max_containers" name="max_containers" value="{{ max_containers|default(0) }}">
          </div>

          <div class="col-md-6">
            <label for="max_vps_per_user" class="form-label">Max VPS per User</label>
            <input type="text" min="0" class="form-control" id="max_vps_per_user" name="max_vps_per_user" value="{{ max_vps_per_user|default(0) }}">
          </div>

<div class="col-md-6">
  <label for="custom_background" class="form-label">Custom Background</label>
  <input type="text" class="form-control" id="custom_background" name="custom_background" value="{{ custom_background|default('https://motionbgs.com/media/5296/orange-train-at-sunset.1920x1080.mp4') }}">
</div>


          <div class="col-12">
            <button type="submit" class="btn btn-primary">Save Settings</button>
            <a href="/admin/settings/reset" class="btn btn-outline-danger ms-2" onclick="return confirm('Reset settings to defaults?');">Reset to Defaults</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Users -->
  <div class="card shadow-sm mb-4" id="users-table">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Users</h5>
      <div class="d-flex">
        <input id="userSearch" class="form-control form-control-sm me-2" placeholder="Search users (id, username, email)">
        <a href="/admin/add_user" class="btn btn-sm btn-primary">Add User</a>
      </div>
    </div>

    <div class="card-body table-responsive">
      <table class="table table-hover table-sm align-middle" id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Role</th>
            <th>Email</th>
            <th>Created At</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr data-user-id="{{ user.id }}">
            <td>{{ user.id }}</td>
            <td>{{ user.username }}</td>
            <td><span class="badge bg-{{ 'primary' if user.role == 'admin' else 'secondary' }}">{{ user.role }}</span></td>
            <td>{{ user.email|default('—') }}</td>
            <td><span class="timestamp" data-ts="{{ user.created_at }}">{{ user.created_at }}</span></td>
            <td class="text-end">
              <a href="/admin/edit_user/{{ user.id }}" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Edit user"><i class="bi bi-pencil"></i> Edit</a>

              <form method="post" action="/admin/delete_user/{{ user.id }}" class="d-inline ms-1 delete-user-form" onsubmit="return confirmDeleteUser(event, '{{ user.username }}');">
                {{ csrf_token() if csrf_token is defined }}
                <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete user">Delete</button>
              </form>

              {% if user.id in banned_users %}
                <a href="/admin/user/{{ user.id }}/unban" class="btn btn-sm btn-success ms-1">Unban</a>
              {% else %}
                <a href="/admin/user/{{ user.id }}/ban" class="btn btn-sm btn-warning ms-1">Ban</a>
              {% endif %}

              {% if user.role == 'admin' %}
                <a href="/admin/user/{{ user.id }}/remove_admin" class="btn btn-sm btn-secondary ms-1">Remove Admin</a>
              {% else %}
                <a href="/admin/user/{{ user.id }}/make_admin" class="btn btn-sm btn-primary ms-1">Make Admin</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<!-- VPS Instances -->
<div class="card shadow-sm mb-4" id="vps-table">
  <!-- Header -->
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h5 class="mb-0">VPS Instances</h5>
    <div class="d-flex gap-2">
      <input id="vpsSearch" class="form-control form-control-sm" placeholder="Search VPS ID / Owner">
      <a href="/create_vps" class="btn btn-sm btn-primary">+ Create VPS</a>
    </div>
  </div>

<!-- Stats -->
<div class="card-body border-bottom pb-2">
  <div class="row text-center text-sm-start g-3">
    <div class="col-12 col-sm-4">
      <div class="p-2 bg-light rounded text-dark">
        <strong>Total VPS:</strong> {{ total_vps }}
      </div>
    </div>
    <div class="col-12 col-sm-4">
      <div class="p-2 bg-light rounded text-dark">
        <strong>Total Restarts:</strong> {{ total_restarts }}
      </div>
    </div>
    <div class="col-12 col-sm-4">
      <div class="p-2 bg-light rounded text-dark">
        <strong>Total Created:</strong> {{ total_vps_created }}
      </div>
    </div>
  </div>
</div>


  <!-- VPS Table -->
  <div class="card-body table-responsive">
    <table class="table table-hover table-sm align-middle text-center mb-0" id="vpsTable">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Owner</th>
          <th>CPU</th>
          <th>RAM</th>
          <th>Disk</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for vps in vps_list %}
        <tr>
          <!-- VPS ID -->
          <td class="fw-bold">{{ vps.vps_id }}</td>

          <!-- Status Badge -->
          {% set status_badge = 'success' if vps.status == 'running' else 'secondary' if vps.status == 'stopped' else 'warning' if vps.status == 'suspended' else 'danger' %}
          <td><span class="badge bg-{{ status_badge }} text-uppercase">{{ vps.status }}</span></td>

          <!-- Owner -->
          <td>{{ vps.created_by }}</td>

          <!-- Resources -->
          <td><span class="fw-semibold">{{ vps.cpu }}</span> cores</td>
          <td><span class="fw-semibold">{{ vps.memory }}</span> GB</td>
          <td><span class="fw-semibold">{{ vps.disk }}</span> GB</td>

          <!-- Actions -->
          <td class="text-end">
            <a href="/vps/{{ vps.vps_id }}" class="btn btn-sm btn-outline-info">
              <i class="bi bi-info-circle"></i> Details
            </a>
            <a href="/edit_vps/{{ vps.vps_id }}" class="btn btn-sm btn-outline-primary ms-1">
              <i class="bi bi-pencil-square"></i> Edit
            </a>
            {% if vps.status == 'suspended' %}
              <a href="/admin/vps/{{ vps.vps_id }}/unsuspend" class="btn btn-sm btn-success ms-1">
                <i class="bi bi-play-circle"></i> Unsuspend
              </a>
            {% else %}
              <a href="/admin/vps/{{ vps.vps_id }}/suspend" class="btn btn-sm btn-warning ms-1">
                <i class="bi bi-pause-circle"></i> Suspend
              </a>
            {% endif %}
            <a href="/admin/vps/{{ vps.vps_id }}/renew" class="btn btn-sm btn-secondary ms-1">
              <i class="bi bi-arrow-repeat"></i> Renew
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Admin Tabs -->
<div class="card shadow-sm mb-4">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit-logs-tab" type="button" role="tab">
          Audit Logs
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent-logs-tab" type="button" role="tab">
          Recent Logs
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-actions-tab" type="button" role="tab">
          System Actions
        </button>
      </li>
    </ul>
  </div>

  <div class="card-body tab-content">
    <!-- Audit Logs -->
    <div class="tab-pane fade show active" id="audit-logs-tab" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Audit Logs</h5>
        <div class="text-muted small">Showing last {{ audit_logs|length }} entries</div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>User ID</th>
              <th>Action</th>
              <th>Details</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            {% for log in audit_logs %}
            <tr>
              <td>{{ log.user_id }}</td>
              <td>{{ log.action }}</td>
              <td class="text-break">{{ log.details }}</td>
              <td><span class="timestamp" data-ts="{{ log.timestamp }}">{{ log.timestamp }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Recent Logs -->
    <div class="tab-pane fade" id="recent-logs-tab" role="tabpanel">
      <h5>Recent Logs</h5>
      <pre class="bg-light p-3 border rounded small" style="max-height:280px; overflow:auto;">{{ recent_logs|default('No logs') }}</pre>
    </div>

    <!-- System Actions -->
    <div class="tab-pane fade" id="system-actions-tab" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">System Actions</h5>
        <small class="text-muted">Use with care — some actions are irreversible</small>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="/admin/backup" class="btn btn-primary">Backup Database</a>

        <form method="post" action="/admin/restore" enctype="multipart/form-data" class="d-inline">
          {{ csrf_token() if csrf_token is defined }}
          <label class="btn btn-outline-secondary mb-0">
            <input type="file" name="backup_file" required hidden>
            Restore Database
          </label>
        </form>

        <a href="/admin/docker_prune" class="btn btn-warning" onclick="return confirm('Prune docker system? This will remove unused data.')">Prune Docker</a>
        <a href="/admin/export_vps" class="btn btn-info">Export VPS CSV</a>
        <a href="/admin/export_users" class="btn btn-info">Export Users CSV</a>
        <a href="/admin/groups" class="btn btn-outline-primary">Manage Groups</a>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// enable Bootstrap tooltips if Bootstrap JS is loaded
(function(){
  if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
  }
})();

// Simple client-side search for users and vps tables
function tableSearch(inputId, tableId) {
  const input = document.getElementById(inputId);
  if (!input) return;
  input.addEventListener('input', function() {
    const q = this.value.trim().toLowerCase();
    const rows = document.querySelectorAll(`#${tableId} tbody tr`);
    rows.forEach(r => {
      const text = r.textContent.toLowerCase();
      r.style.display = q === '' || text.indexOf(q) !== -1 ? '' : 'none';
    });
  });
}

tableSearch('userSearch', 'usersTable');
tableSearch('vpsSearch', 'vpsTable');

// Format ISO timestamps into local readable form if they look like ISO strings
function prettifyTimestamps() {
  document.querySelectorAll('.timestamp').forEach(el => {
    const ts = el.getAttribute('data-ts');
    if (!ts) return;
    const d = new Date(ts);
    if (!isNaN(d)) {
      el.textContent = d.toLocaleString();
    }
  });
}
prettifyTimestamps();

// confirm delete user helper
function confirmDeleteUser(e, username) {
  if (!confirm(`Delete user "${username}"? This cannot be undone.`)) {
    e.preventDefault();
    return false;
  }
  return true;
}
</script>
{% endblock %}
